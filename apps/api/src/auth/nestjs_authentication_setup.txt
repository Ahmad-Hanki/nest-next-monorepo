# ðŸ” NestJS + GraphQL + Next.js Authentication & Refresh Token Setup

## ðŸ› ï¸ Dependencies

Install all required packages:

npm i argon2 @nestjs/jwt @nestjs/passport passport passport-jwt @nestjs/config
npm i -D @types/passport-jwt

---

## ðŸ”¹ Step 1: User Creation (Register)

**File:** apps/api/src/user/user.service.ts  
- Hash the password using `argon2` before saving.  
- Implement `createUser()` to save the user with a **hashed password**.  

âœ… Example:
```ts
const hashedPassword = await hash(createUserInput.password);
return this.prisma.user.create({
  data: { ...createUserInput, password: hashedPassword },
});
```

---

## ðŸ”¹ Step 2: AuthService â€“ Login, Token Generation & Refresh

**File:** apps/api/src/auth/auth.service.ts

Handles:
- `validateLocalUser()` â†’ validates email and password using `argon2.verify()`
- `generateTokens()` â†’ creates both **access** and **refresh tokens**
- `login()` â†’ returns user data + both tokens
- `refreshToken()` â†’ verifies old token, fetches user from DB, and issues **new tokens**

âœ… Features:
- Refresh token is **hashed and stored in DB** (`user.refreshToken`).
- Access token expires in **24h**, refresh token in **7 days**.
- When refreshed, both tokens are rotated securely.

---

## ðŸ”¹ Step 3: AuthModule Setup

**File:** apps/api/src/auth/auth.module.ts

Import and configure JWT:

```ts
JwtModule.registerAsync({
  useFactory: (configService: ConfigService) => ({
    secret: configService.get<string>('JWT_SECRET'),
    signOptions: { expiresIn: '24h' },
  }),
  inject: [ConfigService],
})
```

âœ… Donâ€™t forget to export the `AuthService`.

---

## ðŸ”¹ Step 4: Enable ConfigModule (Global Environment Variables)

**File:** apps/api/src/app.module.ts

```ts
imports: [ConfigModule.forRoot({ isGlobal: true })]
```

Allows access to environment variables such as:
```env
JWT_SECRET=supersecretkey
DATABASE_URL=your_postgres_url
```

---

## ðŸ”¹ Step 5: JWT Strategy

**File:** apps/api/src/auth/strategies/jwt.strategy.ts

Defines how JWTs are extracted and validated:
- Extract token from `Authorization: Bearer TOKEN`
- Validate with your `JWT_SECRET`
- Attach the user ID to the request by calling:
```ts
return this.authService.validateJwtUser(payload.sub);
```

---

## ðŸ”¹ Step 6: Auth Guard (Protect Routes)

**Generate:**
```bash
nest g gu auth/guards/jwt-auth
```

**File:** apps/api/src/auth/guards/jwt-auth.guard.ts

Guards routes that require login:
```ts
@UseGuards(JwtAuthGuard)
@Query(() => User)
me(@CurrentUser() user: User) {
  return user;
}
```

âœ… Only users with a valid JWT token can access protected resolvers.

---

## ðŸ”¹ Step 7: CurrentUser Decorator

**File:** apps/api/src/auth/decorators/current-user.decorator.ts

Simplifies extracting user from the request.

Usage:
```ts
@UseGuards(JwtAuthGuard)
updateUser(@CurrentUser() user: User) {
  console.log(user.id);
}
```

---

## ðŸ”¹ Step 8: Refresh Token Mutation (GraphQL)

**File:** apps/api/src/auth/auth.resolver.ts

Adds a GraphQL mutation for refreshing the access token:
```ts
@Mutation(() => String)
async refreshToken(@Args('token') token: string) {
  const { accessToken } = await this.authService.refreshToken(token);
  return accessToken;
}
```

---

## ðŸ”¹ Step 9: Frontend Integration (Next.js)

### âœ… 9.1. Prefetch User (Server)
**File:** app/layout.tsx  
- Prefetch `Me` query  
- If token expired â†’ render `<RefreshAccessToken />`

### âœ… 9.2. Refresh Token Component
**File:** components/refresh-token.tsx  
Automatically refreshes and sets new cookie:
```ts
const { refreshToken: accessToken } = await sdk.RefreshToken({
  token: cookie.accessToken,
});
setAuthCookie(accessToken, cookie.role);
window.location.reload();
```

### âœ… 9.3. Auth Cookie Utilities
**File:** lib/auth-cookies.ts  
Handles reading, setting, and clearing cookies (`httpOnly`, secure, etc.)

---

## âœ… Summary

| Feature | Status | Description |
|----------|--------|-------------|
| Password hashing | âœ… | Secure with argon2 |
| JWT generation | âœ… | Access + Refresh |
| Refresh token storage | âœ… | Hashed in DB |
| Token rotation | âœ… | New tokens each refresh |
| Auth Guard | âœ… | Protects private routes |
| CurrentUser decorator | âœ… | Simplifies user access |
| Frontend integration | âœ… | Refresh + Prefetch handled |

---

ðŸš€ **Result:**  
You now have a **fully functional and secure JWT + Refresh Token system** integrated with **NestJS + GraphQL + Next.js (React Query)**.  
Itâ€™s production-ready and follows the same best practices used in enterprise apps.
